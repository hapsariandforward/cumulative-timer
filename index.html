<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cumulative Input Timer</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    button { padding: 10px; margin: 5px; }
    .timer-display { font-size: 2em; margin: 20px 0; }
    .analytics { margin-top: 20px; }
    .percentage { font-size: 1.5em; font-weight: bold; margin-top: 10px; }
    .badge {
      margin-top: 10px;
      padding: 5px;
      background-color: #ffeb3b;
      border-radius: 4px;
      display: inline-block;
      margin-right: 5px;
      margin-bottom: 5px;
    }
    .custom-input { margin: 10px 5px; }
  </style>
</head>
<body>

<h2>Indonesian Comprehensible Input Timer</h2>

<!-- Authentication Section -->
<div id="authSection" style="display: block;">
  <button id="signInButton">Sign in with Google</button>
</div>

<!-- Timer App Section (hidden until signed in) -->
<div id="timerSection" style="display:none;">
  <div class="timer-display" id="timerDisplay">0 mins</div>
  <div>
    <button id="add1">+1 min</button>
    <button id="add5">+5 mins</button>
    <button id="add15">+15 mins</button>
    <button id="add30">+30 mins</button>
    <button id="add60">+1 hr</button>
    <button id="undo">Undo</button>
    <button id="reset">Reset Today</button>
    <br>
    <input class="custom-input" type="number" id="customTime" placeholder="Custom time in mins" min="1">
    <button id="addCustom">Add Custom Time</button>
  </div>
  <div class="analytics">
    <div class="percentage" id="progressPercentage"></div>
    <p id="dailyAvg"></p>
    <div id="streak"></div>
    <div id="badges"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

  // Replace with your own Firebase config if needed.
  const firebaseConfig = {
    apiKey: "AIzaSyC1Qwv5MIsxykfI8QNWXm7zy6A_yg7v2-k",
    authDomain: "cumulative-timer-app.firebaseapp.com",
    projectId: "cumulative-timer-app",
    storageBucket: "cumulative-timer-app.firebasestorage.app",
    messagingSenderId: "752490804648",
    appId: "1:752490804648:web:64e54ee6dab6d75ad6599d",
    measurementId: "G-PTCS51X0SR"
  };

  // Initialize Firebase
  const appFirebase = initializeApp(firebaseConfig);
  const auth = getAuth(appFirebase);
  const db = getFirestore(appFirebase);
  const provider = new GoogleAuthProvider();

  // Sign in with Google
  document.getElementById("signInButton").onclick = () => {
    signInWithPopup(auth, provider)
      .then((result) => {
        console.log("Signed in as:", result.user.displayName);
      })
      .catch((error) => {
        console.error("Sign-in error:", error);
      });
  };

  let currentUserId = null;
  // Load existing history from localStorage
  let history = JSON.parse(localStorage.getItem('timerHistory')) || [];
  let unsubscribe = null; // We'll store the Firestore listener unsubscribe function.

  // Define the badges
  const badges = [
    { mins: 1800,  label: 'Pemula Ceria ðŸ˜Š' },
    { mins: 3550,  label: 'Pecinta Bahasa ðŸ’¬' },
    { mins: 5450,  label: 'Orang Pintar ðŸ§ ' },
    { mins: 7200,  label: 'Pelajar Semangat ðŸ“–' },
    { mins: 8950,  label: 'Si Kritis ðŸ”' },
    { mins: 10850, label: 'Dukun Muda ðŸ”®' },
    { mins: 12500, label: 'Raden Muda ðŸŽ©' },
    { mins: 14450, label: 'Pak Guru Canggih ðŸ“š' },
    { mins: 16100, label: 'Juragan Cerdas ðŸ’°' },
    { mins: 18000, label: 'Pendekar Lincah âš”ï¸' },
    { mins: 19750, label: 'Sultan Santai ðŸ‘‘' },
    { mins: 21700, label: 'Raja Dangdut Keren ðŸŽ¤' },
    { mins: 23350, label: 'Garuda Jaya ðŸ¦…' },
    { mins: 25250, label: 'Pahlawan Nusantara ðŸ›¡ï¸' },
    { mins: 26900, label: 'Legenda Jalanan ðŸŒŸ' },
    { mins: 28800, label: 'Mbah Mutiara ðŸ’Ž' },
    { mins: 30550, label: 'Dewa Cerita ðŸ†' },
    { mins: 32450, label: 'Sahabat Sejati ðŸ¤' },
    { mins: 34100, label: 'Pionir Digital ðŸ’»' },
    { mins: 36000, label: 'Penyair Rindu ðŸŽ¼' },
    { mins: 37750, label: 'Jagoan Lokal ðŸ¥‡' },
    { mins: 39650, label: 'Ratu Kreatif ðŸŽ¨' },
    { mins: 41350, label: 'Bintang Fajar ðŸŒ…' },
    { mins: 43200, label: 'Pengelana Hati ðŸš€' },
    { mins: 44950, label: 'Singa Berkeliaran ðŸ¦' },
    { mins: 46850, label: 'Penyulut Semangat ðŸ”¥' },
    { mins: 48550, label: 'Pejuang Lembut ðŸ’ª' },
    { mins: 50350, label: 'Cendekiawan Urban ðŸ™ï¸' },
    { mins: 52150, label: 'Mahakarya Hidup ðŸŽ­' },
    { mins: 54000, label: 'Empu Inovasi âš™ï¸' },
    { mins: 55750, label: 'Sang Visioner ðŸ”­' },
    { mins: 57550, label: 'Pangeran Progres ðŸ“ˆ' },
    { mins: 60000, label: 'Dewa Bahasa Sejati ðŸ†' }
  ];

  // Save local changes to Firestore
  function saveHistory() {
    localStorage.setItem('timerHistory', JSON.stringify(history));
    if (currentUserId) {
      const userDoc = doc(db, "timerData", currentUserId);
      setDoc(userDoc, { history }).catch(err => console.error("Error saving to Firestore:", err));
    }
  }

  // Listen for real-time changes using onSnapshot
  function subscribeToHistory(uid) {
    const userDoc = doc(db, "timerData", uid);
    unsubscribe = onSnapshot(userDoc, (docSnap) => {
      if (docSnap.exists()) {
        history = docSnap.data().history || [];
        localStorage.setItem('timerHistory', JSON.stringify(history));
        updateDisplay(); // Refresh UI any time data changes in Firestore
      } else {
        console.log("No data in Firestore for this user yet.");
      }
    }, (err) => {
      console.error("Realtime listener error:", err);
    });
  }

  // Streak calculation
  function computeStreak() {
    const daysSet = new Set(history.map(entry => entry.date.split('T')[0]));
    let streak = 0;
    let currentDate = new Date();
    while (true) {
      const dateStr = currentDate.toISOString().split('T')[0];
      if (daysSet.has(dateStr)) {
        streak++;
        currentDate.setDate(currentDate.getDate() - 1);
      } else {
        break;
      }
    }
    return streak;
  }

  // Format minutes into hours + minutes
  function formatTime(minutes) {
    const hrs = Math.floor(minutes / 60);
    const mins = minutes % 60;
    return hrs > 0
      ? `${hrs} hr${hrs > 1 ? 's' : ''} ${mins} min${mins !== 1 ? 's' : ''}`
      : `${mins} min${mins !== 1 ? 's' : ''}`;
  }

  // Update UI based on current "history"
  function updateDisplay() {
    const totalMinutes = history.reduce((acc, entry) => acc + entry.minutes, 0);
    document.getElementById("timerDisplay").innerText = formatTime(totalMinutes);

    const firstEntryDate = history.length ? new Date(history[0].date) : new Date();
    const daysPassed = Math.ceil((new Date() - firstEntryDate) / (1000 * 60 * 60 * 24)) || 1;
    const dailyAvg = Math.floor(totalMinutes / daysPassed);
    document.getElementById("dailyAvg").innerText = `Daily average: ${formatTime(dailyAvg)}/day`;

    const streak = computeStreak();
    document.getElementById("streak").innerText = `Daily Streak: ${streak} day${streak !== 1 ? "s" : ""}`;

    const percentage = ((totalMinutes / 60000) * 100).toFixed(2);
    document.getElementById("progressPercentage").innerText = `Progress: ${percentage}% of goal`;

    const earnedBadges = badges.filter(badge => totalMinutes >= badge.mins);
    document.getElementById("badges").innerHTML = earnedBadges.map(b => `<div class="badge">${b.label}</div>`).join("");

    // After updating the UI, we push changes to Firestore.
    saveHistory();
  }

  // Standard Timer Functions
  function addTime(mins) {
    history.push({ minutes: mins, date: new Date().toISOString() });
    updateDisplay();
  }

  function undoLast() {
    if (history.length > 0) {
      history.pop();
      updateDisplay();
    }
  }

  function resetTimer() {
    if (confirm("Are you sure you want to reset today's entries?")) {
      const today = new Date().toISOString().split("T")[0];
      history = history.filter(entry => entry.date.split("T")[0] !== today);
      updateDisplay();
    }
  }

  function addCustomTime() {
    const input = document.getElementById("customTime");
    const customValue = input.value;
    if (!customValue) {
      alert("Please enter a custom time in minutes.");
      return;
    }
    const minutes = parseInt(customValue, 10);
    if (isNaN(minutes) || minutes <= 0) {
      alert("Please enter a valid positive number of minutes.");
      return;
    }
    addTime(minutes);
    input.value = "";
  }

  // Hook up buttons
  document.getElementById("add1").onclick = () => addTime(1);
  document.getElementById("add5").onclick = () => addTime(5);
  document.getElementById("add15").onclick = () => addTime(15);
  document.getElementById("add30").onclick = () => addTime(30);
  document.getElementById("add60").onclick = () => addTime(60);
  document.getElementById("undo").onclick = undoLast;
  document.getElementById("reset").onclick = resetTimer;
  document.getElementById("addCustom").onclick = addCustomTime;
  document.getElementById("customTime").addEventListener("keydown", (event) => {
    if (event.key === "Enter") {
      addCustomTime();
    }
  });

  // Initialize the display from localStorage on page load.
  updateDisplay();

  onAuthStateChanged(auth, (user) => {
    if (user) {
      // Hide sign-in, show timer.
      document.getElementById("authSection").style.display = "none";
      document.getElementById("timerSection").style.display = "block";

      currentUserId = user.uid;
      console.log("User ID:", currentUserId);

      // If we already had a listener, unsubscribe from it.
      if (unsubscribe) unsubscribe();

      // Subscribe to real-time updates for this user.
      subscribeToHistory(currentUserId);
    } else {
      // If user logs out or not signed in, show sign-in.
      document.getElementById("authSection").style.display = "block";
      document.getElementById("timerSection").style.display = "none";
      // Unsubscribe from changes if we had a listener.
      if (unsubscribe) {
        unsubscribe();
        unsubscribe = null;
      }
    }
  });
</script>

</body>
</html>
