<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cumulative Input Timer (Steampunk Edition)</title>
  <!-- Additional small difference to ensure an update -->
  <style>
    /* Use a steampunk-inspired font from Google Fonts */
    @import url('https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&display=swap');

    body {
      margin: 0;
      padding: 0;
      font-family: 'IM Fell English SC', serif;
      /* Subtle repeating background with gears image */
      background-color: #f9f4ef;
      background-image: url('https://upload.wikimedia.org/wikipedia/commons/5/58/SteamPunkGearTile.png');
      background-size: 200px 200px;
      background-repeat: repeat;
      color: #2f1e0e;
    }

    h2 {
      font-size: 2.5em;
      text-align: center;
      margin-top: 20px;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
    }

    button {
      padding: 10px;
      margin: 5px;
      border-radius: 8px;
      border: 1px solid #b5651d;
      background-color: #f0e1c6;
      cursor: pointer;
      font-family: 'IM Fell English SC', serif;
    }
    button:hover {
      background-color: #e5d5b8;
    }

    .app-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      position: relative;
    }

    .timer-display {
      font-size: 2em;
      margin: 20px 0;
      font-weight: bold;
      text-align: center;
    }

    .analytics {
      margin-top: 20px;
      text-align: center;
    }

    .percentage {
      font-size: 1.5em;
      font-weight: bold;
      margin-top: 10px;
      color: #b5651d;
    }

    .badge {
      margin-top: 10px;
      padding: 5px;
      background-color: #ffeb3b;
      border-radius: 4px;
      display: inline-block;
      margin-right: 5px;
      margin-bottom: 5px;
    }

    .custom-input {
      margin: 10px 5px;
      width: 80px;
      text-align: center;
      border: 2px solid #b5651d;
      border-radius: 4px;
      font-family: 'IM Fell English SC', serif;
    }

    #authSection {
      text-align: center;
      margin-top: 40px;
    }

    /* By default (mobile-first), place stopwatch in flow below the main timer,
       and hide corner gears so they don't overlap on small screens. */
    #timerSection {
      margin-top: 20px;
      padding: 20px;
      background-color: rgba(243, 236, 194, 0.75);
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      border: 4px double #b5651d;
      border-radius: 10px;
      position: relative;
    }
    #timerSection::before,
    #timerSection::after {
      display: none;
      content: '';
    }

    .stopwatch-container {
      margin: 20px auto 0 auto;
      width: 100%;
      max-width: 320px;
      padding: 10px;
      border: 3px dashed #b5651d;
      background-color: #f3ecc2;
      border-radius: 8px;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
      z-index: 2;
    }

    .stopwatch-display {
      font-size: 1.5em;
      margin-bottom: 10px;
      text-align: center;
      color: #4d2c0c;
    }

    /* Desktop Styles (min-width: 769px):
       - Re-enable corner gears
       - Absolutely position stopwatch to top-right
    */
    @media (min-width: 769px) {
      #timerSection {
        margin-top: 20px;
      }
      #timerSection::before,
      #timerSection::after {
        display: block;
        position: absolute;
        width: 80px;
        height: 80px;
        opacity: 0.2;
        pointer-events: none;
        background: url('https://upload.wikimedia.org/wikipedia/commons/3/3f/Cog-font-awesome.svg') center center no-repeat;
        background-size: 80px 80px;
      }
      #timerSection::before {
        top: 0;
        left: 0;
      }
      #timerSection::after {
        bottom: 0;
        right: 0;
      }

      .stopwatch-container {
        position: absolute;
        top: 20px;
        right: 20px;
        width: 220px;
        margin: 0; /* remove the auto margins used on mobile */
      }
    }
  </style>
</head>
<body>
<h2>Indonesian Comprehensible Input Timer</h2>
<div class="app-container">
  <!-- Authentication Section -->
  <div id="authSection" style="display: block;">
    <button id="signInButton">Sign in with Google</button>
  </div>

  <!-- Timer App Section (hidden until signed in) -->
  <div id="timerSection" style="display:none;">
    <div class="timer-display" id="timerDisplay">0 mins</div>
    <div style="text-align: center;">
      <button id="add1">+1 min</button>
      <button id="add5">+5 mins</button>
      <button id="add15">+15 mins</button>
      <button id="add30">+30 mins</button>
      <button id="add60">+1 hr</button>
      <button id="undo">Undo</button>
      <button id="reset">Reset Today</button>
      <br>
      <input class="custom-input" type="number" id="customTime" placeholder="Mins" min="1">
      <button id="addCustom">Add Custom Time</button>
    </div>

    <div class="analytics">
      <div class="percentage" id="progressPercentage"></div>
      <p id="dailyAvg"></p>
      <div id="streak"></div>
      <div id="badges"></div>
    </div>

    <!-- Stopwatch widget -->
    <div class="stopwatch-container" id="stopwatchContainer">
      <div class="stopwatch-display" id="stopwatchDisplay">00:00</div>
      <button id="startStopwatch">Start</button>
      <button id="stopStopwatch">Stop</button>
      <button id="resetStopwatch">Reset</button>
      <br>
      <button id="commitStopwatch">Commit Time</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
  import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    getDoc,
    setDoc,
    onSnapshot
  } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";

  // Slight difference: updated comment below
  // Replace with your own Firebase config if needed.
  const firebaseConfig = {
    apiKey: "AIzaSyC1Qwv5MIsxykfI8QNWXm7zy6A_yg7v2-k",
    authDomain: "cumulative-timer-app.firebaseapp.com",
    projectId: "cumulative-timer-app",
    storageBucket: "cumulative-timer-app.firebasestorage.app",
    messagingSenderId: "752490804648",
    appId: "1:752490804648:web:64e54ee6dab6d75ad6599d",
    measurementId: "G-PTCS51X0SR"
  };

  // Initialize Firebase
  const appFirebase = initializeApp(firebaseConfig);
  const auth = getAuth(appFirebase);
  const db = getFirestore(appFirebase);
  const provider = new GoogleAuthProvider();

  // Sign in with Google
  document.getElementById("signInButton").onclick = () => {
    signInWithPopup(auth, provider)
      .then((result) => {
        console.log("Signed in as:", result.user.displayName);
      })
      .catch((error) => {
        console.error("Sign-in error:", error);
      });
  };

  let currentUserId = null;
  // Load existing history from localStorage
  let history = JSON.parse(localStorage.getItem('timerHistory')) || [];
  let unsubscribe = null; // We'll store the Firestore listener unsubscribe function.

  // Define the badges
  const badges = [
    { mins: 1800,  label: 'Pemula Ceria ðŸ˜Š' },
    { mins: 3550,  label: 'Pecinta Bahasa ðŸ’¬' },
    { mins: 5450,  label: 'Orang Pintar ðŸ§ ' },
    { mins: 7200,  label: 'Pelajar Semangat ðŸ“–' },
    // ... you can keep the rest ...
  ];

  // Save local changes to Firestore
  function saveHistory() {
    localStorage.setItem('timerHistory', JSON.stringify(history));
    if (currentUserId) {
      const userDoc = doc(db, "timerData", currentUserId);
      setDoc(userDoc, { history }).catch(err => console.error("Error saving to Firestore:", err));
    }
  }

  // Listen for real-time changes using onSnapshot
  function subscribeToHistory(uid) {
    const userDoc = doc(db, "timerData", uid);
    unsubscribe = onSnapshot(userDoc, (docSnap) => {
      if (docSnap.exists()) {
        history = docSnap.data().history || [];
        localStorage.setItem('timerHistory', JSON.stringify(history));
        updateDisplay(); // Refresh UI any time data changes in Firestore
      } else {
        console.log("No data in Firestore for this user yet.");
      }
    }, (err) => {
      console.error("Realtime listener error:", err);
    });
  }

  // Streak calculation
  function computeStreak() {
    const daysSet = new Set(history.map(entry => entry.date.split('T')[0]));
    let streak = 0;
    let currentDate = new Date();
    while (true) {
      const dateStr = currentDate.toISOString().split('T')[0];
      if (daysSet.has(dateStr)) {
        streak++;
        currentDate.setDate(currentDate.getDate() - 1);
      } else {
        break;
      }
    }
    return streak;
  }

  // Format minutes into hours + minutes
  function formatTime(minutes) {
    const hrs = Math.floor(minutes / 60);
    const mins = minutes % 60;
    return hrs > 0
      ? `${hrs} hr${hrs > 1 ? 's' : ''} ${mins} min${mins !== 1 ? 's' : ''}`
      : `${mins} min${mins !== 1 ? 's' : ''}`;
  }

  // Update UI based on current "history"
  function updateDisplay() {
    const totalMinutes = history.reduce((acc, entry) => acc + entry.minutes, 0);
    document.getElementById("timerDisplay").innerText = formatTime(totalMinutes);

    const firstEntryDate = history.length ? new Date(history[0].date) : new Date();
    const daysPassed = Math.ceil((new Date() - firstEntryDate) / (1000 * 60 * 60 * 24)) || 1;
    const dailyAvg = Math.floor(totalMinutes / daysPassed);
    document.getElementById("dailyAvg").innerText = `Daily average: ${formatTime(dailyAvg)}/day`;

    const streak = computeStreak();
    document.getElementById("streak").innerText = `Daily Streak: ${streak} day${streak !== 1 ? "s" : ""}`;

    const percentage = ((totalMinutes / 60000) * 100).toFixed(2);
    document.getElementById("progressPercentage").innerText = `Progress: ${percentage}% of goal`;

    // Possibly add the rest of your badge thresholds here
    // ...
    saveHistory();
  }

  // Standard Timer Functions
  function addTime(mins) {
    history.push({ minutes: mins, date: new Date().toISOString() });
    updateDisplay();
  }

  function undoLast() {
    if (history.length > 0) {
      history.pop();
      updateDisplay();
    }
  }

  function resetTimer() {
    if (confirm("Are you sure you want to reset today's entries?")) {
      const today = new Date().toISOString().split("T")[0];
      history = history.filter(entry => entry.date.split("T")[0] !== today);
      updateDisplay();
    }
  }

  function addCustomTime() {
    const input = document.getElementById("customTime");
    const customValue = input.value;
    if (!customValue) {
      alert("Please enter a custom time in minutes.");
      return;
    }
    const minutes = parseInt(customValue, 10);
    if (isNaN(minutes) || minutes <= 0) {
      alert("Please enter a valid positive number of minutes.");
      return;
    }
    addTime(minutes);
    input.value = "";
  }

  // Hook up buttons
  document.getElementById("add1").onclick = () => addTime(1);
  document.getElementById("add5").onclick = () => addTime(5);
  document.getElementById("add15").onclick = () => addTime(15);
  document.getElementById("add30").onclick = () => addTime(30);
  document.getElementById("add60").onclick = () => addTime(60);
  document.getElementById("undo").onclick = undoLast;
  document.getElementById("reset").onclick = resetTimer;
  document.getElementById("addCustom").onclick = addCustomTime;
  document.getElementById("customTime").addEventListener("keydown", (event) => {
    if (event.key === "Enter") {
      addCustomTime();
    }
  });

  // ---------------------------------------------------
  // STOPWATCH LOGIC
  // ---------------------------------------------------
  let stopwatchInterval = null;
  let stopwatchSeconds = 0;

  const stopwatchDisplay = document.getElementById("stopwatchDisplay");
  const startBtn = document.getElementById("startStopwatch");
  const stopBtn = document.getElementById("stopStopwatch");
  const resetBtn = document.getElementById("resetStopwatch");
  const commitBtn = document.getElementById("commitStopwatch");

  function updateStopwatchDisplay() {
    // Convert total seconds into mm:ss
    const m = Math.floor(stopwatchSeconds / 60);
    const s = stopwatchSeconds % 60;
    const mm = m < 10 ? "0" + m : m;
    const ss = s < 10 ? "0" + s : s;
    stopwatchDisplay.textContent = `${mm}:${ss}`;
  }

  function startStopwatch() {
    if (stopwatchInterval) return; // already running
    stopwatchInterval = setInterval(() => {
      stopwatchSeconds++;
      updateStopwatchDisplay();
    }, 1000);
  }

  function stopStopwatch() {
    if (stopwatchInterval) {
      clearInterval(stopwatchInterval);
      stopwatchInterval = null;
    }
  }

  function resetStopwatch() {
    stopStopwatch();
    stopwatchSeconds = 0;
    updateStopwatchDisplay();
  }

  function commitStopwatch() {
    const minutes = Math.floor(stopwatchSeconds / 60);
    if (minutes > 0) {
      addTime(minutes);
      alert(`Committed ${minutes} minute(s) to your overall timer.`);
    } else {
      alert("Stopwatch time is less than 1 minute; not added.");
    }
  }

  startBtn.onclick = startStopwatch;
  stopBtn.onclick = stopStopwatch;
  resetBtn.onclick = resetStopwatch;
  commitBtn.onclick = commitStopwatch;

  // Initialize the display from localStorage on page load.
  updateDisplay();
  updateStopwatchDisplay();

  onAuthStateChanged(auth, (user) => {
    if (user) {
      document.getElementById("authSection").style.display = "none";
      document.getElementById("timerSection").style.display = "block";
      currentUserId = user.uid;
      console.log("User ID:", currentUserId);

      if (unsubscribe) unsubscribe();
      subscribeToHistory(currentUserId);
    } else {
      document.getElementById("authSection").style.display = "block";
      document.getElementById("timerSection").style.display = "none";
      if (unsubscribe) {
        unsubscribe();
        unsubscribe = null;
      }
    }
  });
</script>
</body>
</html>
